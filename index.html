<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portf√∂y Takip</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0f1c;
            --bg-secondary: #111827;
            --bg-card: #1a2235;
            --bg-card-hover: #222d45;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-orange: #f59e0b;
            --accent-cyan: #06b6d4;
            --border-color: rgba(148, 163, 184, 0.1);
        }

        .light {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-card-hover: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: rgba(15, 23, 42, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            margin-bottom: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .logo-text {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-btn:hover { background: var(--bg-card-hover); }
        .header-btn.updating { animation: pulse 1s infinite; }
        .header-btn.success { color: var(--accent-green); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Banner */
        .update-banner {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            animation: fadeInUp 0.3s ease;
        }

        .update-banner.error {
            background: linear-gradient(135deg, var(--accent-red), var(--accent-orange));
        }

        .update-banner .close-banner {
            margin-left: auto;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            opacity: 0.7;
        }

        .last-update {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 16px;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .summary-card.main {
            grid-column: span 2;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
        }

        .summary-card.main .summary-label,
        .summary-card.main .summary-value,
        .summary-card.main .summary-sub {
            color: white;
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .summary-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .summary-card.main .summary-value { font-size: 32px; }

        .summary-sub {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .profit { color: var(--accent-green) !important; }
        .loss { color: var(--accent-red) !important; }

        /* Performance Cards */
        .perf-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .perf-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 14px;
            border: 1px solid var(--border-color);
        }

        .perf-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .perf-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 18px;
            font-weight: 600;
        }

        /* Section */
        .section { margin-bottom: 24px; }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Holdings List */
        .holdings-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .holding-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            animation: fadeInUp 0.4s ease forwards;
        }

        .holding-card:hover {
            background: var(--bg-card-hover);
            transform: translateX(4px);
        }

        .holding-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            flex-shrink: 0;
        }

        .holding-icon.stock-us { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .holding-icon.stock-tr { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .holding-icon.cash { background: linear-gradient(135deg, #10b981, #059669); }
        .holding-icon.deposit { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
        .holding-icon.crypto { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .holding-icon.gold { background: linear-gradient(135deg, #fbbf24, #b45309); }
        .holding-icon.etf-us { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .holding-icon.fund-tr { background: linear-gradient(135deg, #ec4899, #db2777); }
        .holding-icon.viop { background: linear-gradient(135deg, #84cc16, #65a30d); }

        .holding-info { flex: 1; min-width: 0; }

        .holding-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .holding-detail {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .holding-values { text-align: right; }

        .holding-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .holding-change {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            margin-top: 2px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 18px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .fab:hover { transform: scale(1.05); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 24px 24px 0 0;
            padding: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal { transform: translateY(0); }

        .modal-handle {
            width: 40px;
            height: 4px;
            background: var(--text-muted);
            border-radius: 2px;
            margin: 0 auto 20px;
            opacity: 0.5;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            text-align: center;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 24px;
            background: var(--bg-card);
            padding: 6px;
            border-radius: 14px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 60px;
            padding: 10px 8px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-family: 'Outfit', sans-serif;
            font-size: 13px;
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
        }

        /* Form */
        .form-group { margin-bottom: 16px; }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Autocomplete */
        .autocomplete-wrapper { position: relative; }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .autocomplete-list.active { display: block; }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item:hover { background: var(--bg-card-hover); }

        .autocomplete-item .symbol {
            font-weight: 600;
            color: var(--text-primary);
        }

        .autocomplete-item .name {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .autocomplete-loading {
            padding: 16px;
            text-align: center;
            color: var(--text-muted);
        }

        .currency-select {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .currency-btn {
            padding: 10px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-card);
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .currency-btn.active {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-blue);
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }

        .btn-secondary {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 8px;
        }

        /* Confirm Modal */
        .confirm-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 20px;
            width: 90%;
            max-width: 320px;
            z-index: 1001;
            text-align: center;
        }

        .confirm-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .confirm-message {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .confirm-buttons {
            display: flex;
            gap: 12px;
        }

        .confirm-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }

        .confirm-cancel {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .confirm-ok {
            background: var(--accent-red);
            color: white;
        }

        /* Chart */
        .chart-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .chart-bar {
            height: 12px;
            border-radius: 6px;
            display: flex;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .chart-segment {
            height: 100%;
            transition: width 0.5s ease;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Filter Tabs */
        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .filter-tab {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .filter-tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-chart-pie"></i></div>
                <span class="logo-text">Portf√∂y</span>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="refreshBtn" title="Fiyatlarƒ± G√ºncelle">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="header-btn" id="importBtn" title="ƒ∞√ße Aktar">
                    <i class="fas fa-file-import"></i>
                </button>
                <button class="header-btn" id="exportBtn" title="Dƒ±≈üa Aktar">
                    <i class="fas fa-file-export"></i>
                </button>
                <button class="header-btn" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
            <input type="file" id="fileInput" accept=".json" style="display:none">
        </header>

        <div id="bannerContainer"></div>
        <div class="last-update" id="lastUpdate"></div>

        <!-- Summary -->
        <div class="summary-grid">
            <div class="summary-card main">
                <div class="summary-label">Toplam Portf√∂y (USD)</div>
                <div class="summary-value" id="totalValue">$0</div>
                <div class="summary-sub" id="totalProfitLoss">--</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Hisse</div>
                <div class="summary-value" id="stockValue">$0</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Nakit</div>
                <div class="summary-value" id="cashValue">$0</div>
            </div>
        </div>

        <!-- Performance -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Performans</h2>
            </div>
            <div class="perf-grid">
                <div class="perf-card">
                    <div class="perf-label">Haftalƒ±k</div>
                    <div class="perf-value" id="weeklyPerf">--</div>
                </div>
                <div class="perf-card">
                    <div class="perf-label">Aylƒ±k</div>
                    <div class="perf-value" id="monthlyPerf">--</div>
                </div>
                <div class="perf-card" style="grid-column: span 2;">
                    <div class="perf-label">Yƒ±llƒ±k</div>
                    <div class="perf-value" id="yearlyPerf">--</div>
                </div>
            </div>
        </div>

        <!-- Distribution -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Daƒüƒ±lƒ±m</h2>
            </div>
            <div class="chart-container" id="chartContainer">
                <div class="chart-bar" id="chartBar"></div>
                <div class="chart-legend" id="chartLegend"></div>
            </div>
        </div>

        <!-- Holdings -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Varlƒ±klar</h2>
            </div>
            <div class="filter-tabs" id="filterTabs">
                <button class="filter-tab active" data-filter="all">T√ºm√º</button>
                <button class="filter-tab" data-filter="stock-us">üá∫üá∏ ABD</button>
                <button class="filter-tab" data-filter="stock-tr">üáπüá∑ BIST</button>
                <button class="filter-tab" data-filter="etf-us">üìä ETF</button>
                <button class="filter-tab" data-filter="fund-tr">üìà Fon</button>
                <button class="filter-tab" data-filter="viop">üìâ Vƒ∞OP</button>
                <button class="filter-tab" data-filter="cash">üíµ Kasa</button>
                <button class="filter-tab" data-filter="deposit">üè¶ Faiz</button>
                <button class="filter-tab" data-filter="gold">ü•á Altƒ±n</button>
                <button class="filter-tab" data-filter="crypto">‚Çø Kripto</button>
            </div>
            <div class="holdings-list" id="holdingsList"></div>
        </div>
    </div>

    <!-- FAB -->
    <button class="fab" id="addBtn"><i class="fas fa-plus"></i></button>

    <!-- Add Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <h2 class="modal-title" id="modalTitle">Varlƒ±k Ekle</h2>

            <div class="tabs" id="typeTabs">
                <button class="tab active" data-type="stock-us">üá∫üá∏ ABD</button>
                <button class="tab" data-type="stock-tr">üáπüá∑ BIST</button>
                <button class="tab" data-type="etf-us">üìä ETF</button>
                <button class="tab" data-type="fund-tr">üìà Fon</button>
                <button class="tab" data-type="viop">üìâ Vƒ∞OP</button>
                <button class="tab" data-type="cash">üíµ Kasa</button>
                <button class="tab" data-type="deposit">üè¶ Faiz</button>
                <button class="tab" data-type="gold">ü•á Altƒ±n</button>
                <button class="tab" data-type="crypto">‚Çø Kripto</button>
            </div>

            <form id="addForm">
                <input type="hidden" id="editId" value="">

                <!-- Stock Fields -->
                <div id="stockFields">
                    <div class="form-group">
                        <label class="form-label">Sembol Ara</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" class="form-input" id="symbolSearch" placeholder="AAPL, MSFT, THYAO..." autocomplete="off">
                            <div class="autocomplete-list" id="autocompleteList"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Se√ßilen Hisse</label>
                        <input type="text" class="form-input" id="selectedStock" readonly placeholder="Yukarƒ±dan se√ßin...">
                        <input type="hidden" id="symbol" value="">
                        <input type="hidden" id="name" value="">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Adet</label>
                            <input type="number" class="form-input" id="quantity" placeholder="0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Alƒ±≈ü Fiyatƒ±</label>
                            <input type="number" class="form-input" id="buyPrice" placeholder="0.00" step="any">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">G√ºncel Fiyat <span id="priceUnit">(USD)</span></label>
                        <input type="number" class="form-input" id="currentPrice" placeholder="0.00" step="any">
                    </div>
                </div>

                <!-- Cash Fields -->
                <div id="cashFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Para Birimi</label>
                        <div class="currency-select" id="currencySelect">
                            <button type="button" class="currency-btn" data-currency="USD">$ USD</button>
                            <button type="button" class="currency-btn active" data-currency="TRY">‚Ç∫ TRY</button>
                            <button type="button" class="currency-btn" data-currency="EUR">‚Ç¨ EUR</button>
                            <button type="button" class="currency-btn" data-currency="GBP">¬£ GBP</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Miktar</label>
                        <input type="number" class="form-input" id="cashAmount" placeholder="0.00" step="any">
                    </div>
                    <div class="form-group">
                        <label class="form-label">A√ßƒ±klama (Opsiyonel)</label>
                        <input type="text" class="form-input" id="cashNote" placeholder="C√ºzdan, kasa...">
                    </div>
                </div>

                <!-- Deposit Fields (Faiz Hesabƒ±) -->
                <div id="depositFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Para Birimi</label>
                        <div class="currency-select" id="depositCurrencySelect">
                            <button type="button" class="currency-btn active" data-currency="TRY">‚Ç∫ TRY</button>
                            <button type="button" class="currency-btn" data-currency="USD">$ USD</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Anapara</label>
                        <input type="number" class="form-input" id="depositAmount" placeholder="0.00" step="any">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Yƒ±llƒ±k Faiz (%)</label>
                            <input type="number" class="form-input" id="interestRate" placeholder="45" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ba≈ülangƒ±√ß Tarihi</label>
                            <input type="date" class="form-input" id="depositStartDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hesap Adƒ± (Opsiyonel)</label>
                        <input type="text" class="form-input" id="depositNote" placeholder="Banka adƒ±, vadeli hesap...">
                    </div>
                </div>

                <!-- Gold Fields -->
                <div id="goldFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Altƒ±n T√ºr√º</label>
                        <select class="form-select" id="goldType">
                            <option value="gram">Gram Altƒ±n</option>
                            <option value="ceyrek">√áeyrek Altƒ±n</option>
                            <option value="yarim">Yarƒ±m Altƒ±n</option>
                            <option value="tam">Tam Altƒ±n</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Adet/Gram</label>
                            <input type="number" class="form-input" id="goldQuantity" placeholder="0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Alƒ±≈ü Fiyatƒ± (‚Ç∫)</label>
                            <input type="number" class="form-input" id="goldBuyPrice" placeholder="0.00" step="any">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">G√ºncel Fiyat (‚Ç∫)</label>
                        <input type="number" class="form-input" id="goldCurrentPrice" placeholder="0.00" step="any">
                    </div>
                </div>

                <!-- Crypto Fields -->
                <div id="cryptoFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Sembol</label>
                        <input type="text" class="form-input" id="cryptoSymbol" placeholder="BTC, ETH, SOL...">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Miktar</label>
                            <input type="number" class="form-input" id="cryptoQuantity" placeholder="0.00" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Alƒ±≈ü Fiyatƒ± ($)</label>
                            <input type="number" class="form-input" id="cryptoBuyPrice" placeholder="0.00" step="any">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">G√ºncel Fiyat ($)</label>
                        <input type="number" class="form-input" id="cryptoCurrentPrice" placeholder="0.00" step="any">
                    </div>
                </div>

                <!-- ETF Fields (US) -->
                <div id="etfFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">ETF Sembol√º Ara</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" class="form-input" id="etfSearch" placeholder="SPY, QQQ, VOO..." autocomplete="off">
                            <div class="autocomplete-list" id="etfAutocompleteList"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Se√ßilen ETF</label>
                        <input type="text" class="form-input" id="selectedEtf" readonly placeholder="Yukarƒ±dan se√ßin...">
                        <input type="hidden" id="etfSymbol" value="">
                        <input type="hidden" id="etfName" value="">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Adet</label>
                            <input type="number" class="form-input" id="etfQuantity" placeholder="0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Alƒ±≈ü Fiyatƒ± ($)</label>
                            <input type="number" class="form-input" id="etfBuyPrice" placeholder="0.00" step="any">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">G√ºncel Fiyat ($)</label>
                        <input type="number" class="form-input" id="etfCurrentPrice" placeholder="0.00" step="any">
                    </div>
                </div>

                <!-- Fund Fields (TR) -->
                <div id="fundFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Fon Kodu</label>
                        <input type="text" class="form-input" id="fundCode" placeholder="TI2, YAY, IPB...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fon Adƒ±</label>
                        <input type="text" class="form-input" id="fundName" placeholder="Fon adƒ±nƒ± girin...">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Pay Adedi</label>
                            <input type="number" class="form-input" id="fundQuantity" placeholder="0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Alƒ±≈ü Fiyatƒ± (‚Ç∫)</label>
                            <input type="number" class="form-input" id="fundBuyPrice" placeholder="0.00" step="any">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">G√ºncel Fiyat (‚Ç∫)</label>
                        <input type="number" class="form-input" id="fundCurrentPrice" placeholder="0.00" step="any">
                    </div>
                </div>

                <!-- VIOP Fields -->
                <div id="viopFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Kontrat Adƒ±</label>
                        <input type="text" class="form-input" id="viopContract" placeholder="F_XU030, F_USDTRY...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pozisyon</label>
                        <div class="currency-select" id="viopPositionSelect">
                            <button type="button" class="currency-btn active" data-position="long">üìà Long</button>
                            <button type="button" class="currency-btn" data-position="short">üìâ Short</button>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Kontrat Sayƒ±sƒ±</label>
                            <input type="number" class="form-input" id="viopQuantity" placeholder="1" step="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Giri≈ü Fiyatƒ± (‚Ç∫)</label>
                            <input type="number" class="form-input" id="viopEntryPrice" placeholder="0.00" step="any">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">G√ºncel Fiyat (‚Ç∫)</label>
                            <input type="number" class="form-input" id="viopCurrentPrice" placeholder="0.00" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label">√áarpan</label>
                            <input type="number" class="form-input" id="viopMultiplier" placeholder="100" value="100" step="any">
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-primary" id="submitBtn">Ekle</button>
                <button type="button" class="btn-secondary" id="deleteBtn" style="display: none;">
                    <i class="fas fa-trash"></i> Sil
                </button>
                <button type="button" class="btn-secondary" id="cancelBtn">ƒ∞ptal</button>
            </form>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="confirm-modal">
            <div class="confirm-title">Silmek istediƒüinize emin misiniz?</div>
            <div class="confirm-message" id="confirmMessage">Bu varlƒ±k kalƒ±cƒ± olarak silinecek.</div>
            <div class="confirm-buttons">
                <button class="confirm-cancel" id="confirmCancel">ƒ∞ptal</button>
                <button class="confirm-ok" id="confirmOk">Sil</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let holdings = [];
        let priceHistory = []; // { date, totalValue }
        let currentType = 'stock-us';
        let currentFilter = 'all';
        let editingId = null;
        let deleteCallback = null;
        let searchTimeout = null;
        let isUpdating = false;
        let lastUpdateTime = null;

        // Exchange rates (USD base)
        const exchangeRates = {
            USD: 1,
            TRY: 0.026,  // 1 TRY = 0.026 USD (1 USD = ~38 TRY)
            EUR: 1.08,
            GBP: 1.26
        };

        // TRY per USD for display
        let usdTryRate = 38.5;

        // DOM Elements
        const addBtn = document.getElementById('addBtn');
        const addModal = document.getElementById('addModal');
        const addForm = document.getElementById('addForm');
        const typeTabs = document.getElementById('typeTabs');
        const filterTabs = document.getElementById('filterTabs');
        const holdingsList = document.getElementById('holdingsList');
        const themeToggle = document.getElementById('themeToggle');
        const confirmModal = document.getElementById('confirmModal');
        const refreshBtn = document.getElementById('refreshBtn');
        const symbolSearch = document.getElementById('symbolSearch');
        const autocompleteList = document.getElementById('autocompleteList');

        // Initialize
        function init() {
            loadData();
            setupEventListeners();
            setupTheme();
            render();
        }

        // Theme
        function setupTheme() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.documentElement.classList.add('light');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.remove('light');
                    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                } else {
                    document.documentElement.classList.add('light');
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                }
            });
        }

        // Event Listeners
        function setupEventListeners() {
            addBtn.addEventListener('click', () => openModal());
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            addModal.addEventListener('click', (e) => {
                if (e.target === addModal) closeModal();
            });

            typeTabs.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchType(tab.dataset.type));
            });

            filterTabs.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => switchFilter(tab.dataset.filter));
            });

            // Cash currency buttons
            document.querySelectorAll('#currencySelect .currency-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#currencySelect .currency-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Deposit currency buttons
            document.querySelectorAll('#depositCurrencySelect .currency-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#depositCurrencySelect .currency-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            addForm.addEventListener('submit', handleSubmit);

            document.getElementById('deleteBtn').addEventListener('click', () => {
                showConfirm('Bu varlƒ±ƒüƒ± silmek istediƒüinize emin misiniz?', () => {
                    deleteHolding(editingId);
                    closeModal();
                });
            });

            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('light');
                const isLight = document.documentElement.classList.contains('light');
                themeToggle.innerHTML = isLight ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            });

            document.getElementById('confirmCancel').addEventListener('click', () => {
                confirmModal.classList.remove('active');
            });

            document.getElementById('confirmOk').addEventListener('click', () => {
                confirmModal.classList.remove('active');
                if (deleteCallback) deleteCallback();
            });

            // Autocomplete for stock search
            symbolSearch.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (searchTimeout) clearTimeout(searchTimeout);

                if (query.length < 2) {
                    autocompleteList.classList.remove('active');
                    return;
                }

                searchTimeout = setTimeout(() => searchStocks(query), 500);
            });

            symbolSearch.addEventListener('focus', () => {
                if (autocompleteList.children.length > 0) {
                    autocompleteList.classList.add('active');
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.autocomplete-wrapper')) {
                    autocompleteList.classList.remove('active');
                    document.getElementById('etfAutocompleteList').classList.remove('active');
                }
            });

            // Vƒ∞OP position buttons
            document.querySelectorAll('#viopPositionSelect .currency-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#viopPositionSelect .currency-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // ETF Search
            const etfSearch = document.getElementById('etfSearch');
            const etfAutocompleteList = document.getElementById('etfAutocompleteList');

            etfSearch.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (searchTimeout) clearTimeout(searchTimeout);

                if (query.length < 2) {
                    etfAutocompleteList.classList.remove('active');
                    return;
                }

                searchTimeout = setTimeout(() => searchEtfs(query), 500);
            });

            etfSearch.addEventListener('focus', () => {
                if (etfAutocompleteList.children.length > 0) {
                    etfAutocompleteList.classList.add('active');
                }
            });
        }

        // ETF Search via Poe API
        function searchEtfs(query) {
            if (!window.Poe) {
                showManualEtfEntry(query);
                return;
            }

            const etfAutocompleteList = document.getElementById('etfAutocompleteList');
            etfAutocompleteList.innerHTML = '<div class="autocomplete-loading"><i class="fas fa-spinner fa-spin"></i> Aranƒ±yor...</div>';
            etfAutocompleteList.classList.add('active');

            window.Poe.registerHandler('etf-search-handler', (result) => {
                const msg = result.responses[0];
                if (msg.status === 'complete') {
                    try {
                        const content = msg.content;
                        const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) ||
                                         content.match(/\[[\s\S]*\]/);
                        let etfs = [];
                        if (jsonMatch) {
                            etfs = JSON.parse(jsonMatch[1] || jsonMatch[0]);
                        }
                        displayEtfResults(etfs, query);
                    } catch (err) {
                        showManualEtfEntry(query);
                    }
                } else if (msg.status === 'error') {
                    showManualEtfEntry(query);
                }
            });

            window.Poe.sendUserMessage(
                `@Grok-4-Fast-Non-Reasoning "${query}" aramasƒ±yla e≈üle≈üen US ETF'lerini bul (NYSE, NASDAQ). Maksimum 5 sonu√ß. SADECE JSON array d√∂nd√ºr:
[{"symbol": "SPY", "name": "SPDR S&P 500 ETF Trust"}, ...]
E≈üle≈üme yoksa bo≈ü array [] d√∂nd√ºr.`,
                {
                    handler: 'etf-search-handler',
                    stream: false,
                    openChat: false
                }
            ).catch(() => showManualEtfEntry(query));
        }

        function displayEtfResults(etfs, query) {
            const etfAutocompleteList = document.getElementById('etfAutocompleteList');
            if (!etfs || etfs.length === 0) {
                showManualEtfEntry(query);
                return;
            }

            etfAutocompleteList.innerHTML = etfs.map(e => `
                <div class="autocomplete-item" data-symbol="${e.symbol}" data-name="${e.name || ''}">
                    <div class="symbol">${e.symbol}</div>
                    <div class="name">${e.name || ''}</div>
                </div>
            `).join('');

            etfAutocompleteList.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', () => selectEtf(item.dataset.symbol, item.dataset.name));
            });

            etfAutocompleteList.classList.add('active');
        }

        function showManualEtfEntry(query) {
            const etfAutocompleteList = document.getElementById('etfAutocompleteList');
            etfAutocompleteList.innerHTML = `
                <div class="autocomplete-item" data-symbol="${query.toUpperCase()}" data-name="">
                    <div class="symbol">${query.toUpperCase()}</div>
                    <div class="name">Manuel giri≈ü</div>
                </div>
            `;
            etfAutocompleteList.querySelector('.autocomplete-item').addEventListener('click', () => {
                selectEtf(query.toUpperCase(), '');
            });
            etfAutocompleteList.classList.add('active');
        }

        function selectEtf(symbol, name) {
            document.getElementById('etfSymbol').value = symbol;
            document.getElementById('etfName').value = name;
            document.getElementById('selectedEtf').value = name ? `${symbol} - ${name}` : symbol;
            document.getElementById('etfSearch').value = '';
            document.getElementById('etfAutocompleteList').classList.remove('active');
        }

        // Stock Search via Poe API
        function searchStocks(query) {
            if (!window.Poe) {
                // Fallback: show manual entry
                showManualStockEntry(query);
                return;
            }

            autocompleteList.innerHTML = '<div class="autocomplete-loading"><i class="fas fa-spinner fa-spin"></i> Aranƒ±yor...</div>';
            autocompleteList.classList.add('active');

            const market = currentType === 'stock-tr' ? 'BIST (Borsa Istanbul)' : 'US Stock Market (NYSE, NASDAQ)';

            window.Poe.registerHandler('stock-search-handler', (result) => {
                const msg = result.responses[0];
                if (msg.status === 'complete') {
                    try {
                        const content = msg.content;
                        const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) ||
                                         content.match(/\[[\s\S]*\]/);
                        let stocks = [];
                        if (jsonMatch) {
                            stocks = JSON.parse(jsonMatch[1] || jsonMatch[0]);
                        }
                        displayStockResults(stocks, query);
                    } catch (err) {
                        showManualStockEntry(query);
                    }
                } else if (msg.status === 'error') {
                    showManualStockEntry(query);
                }
            });

            window.Poe.sendUserMessage(
                `@Grok-4-Fast-Non-Reasoning "${query}" aramasƒ±yla e≈üle≈üen ${market} hisselerini bul. Maksimum 5 sonu√ß. SADECE JSON array d√∂nd√ºr:
[{"symbol": "AAPL", "name": "Apple Inc."}, ...]
E≈üle≈üme yoksa bo≈ü array [] d√∂nd√ºr.`,
                {
                    handler: 'stock-search-handler',
                    stream: false,
                    openChat: false
                }
            ).catch(() => showManualStockEntry(query));
        }

        function displayStockResults(stocks, query) {
            if (!stocks || stocks.length === 0) {
                showManualStockEntry(query);
                return;
            }

            autocompleteList.innerHTML = stocks.map(s => `
                <div class="autocomplete-item" data-symbol="${s.symbol}" data-name="${s.name || ''}">
                    <div class="symbol">${s.symbol}</div>
                    <div class="name">${s.name || ''}</div>
                </div>
            `).join('');

            autocompleteList.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', () => selectStock(item.dataset.symbol, item.dataset.name));
            });

            autocompleteList.classList.add('active');
        }

        function showManualStockEntry(query) {
            autocompleteList.innerHTML = `
                <div class="autocomplete-item" data-symbol="${query.toUpperCase()}" data-name="">
                    <div class="symbol">${query.toUpperCase()}</div>
                    <div class="name">Manuel giri≈ü</div>
                </div>
            `;
            autocompleteList.querySelector('.autocomplete-item').addEventListener('click', () => {
                selectStock(query.toUpperCase(), '');
            });
            autocompleteList.classList.add('active');
        }

        function selectStock(symbol, name) {
            document.getElementById('symbol').value = symbol;
            document.getElementById('name').value = name;
            document.getElementById('selectedStock').value = name ? `${symbol} - ${name}` : symbol;
            symbolSearch.value = '';
            autocompleteList.classList.remove('active');
        }

        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            deleteCallback = callback;
            confirmModal.classList.add('active');
        }

        function switchType(type) {
            currentType = type;
            typeTabs.querySelectorAll('.tab').forEach(t => {
                t.classList.toggle('active', t.dataset.type === type);
            });

            document.getElementById('stockFields').style.display =
                (type === 'stock-us' || type === 'stock-tr') ? 'block' : 'none';
            document.getElementById('cashFields').style.display = type === 'cash' ? 'block' : 'none';
            document.getElementById('depositFields').style.display = type === 'deposit' ? 'block' : 'none';
            document.getElementById('goldFields').style.display = type === 'gold' ? 'block' : 'none';
            document.getElementById('cryptoFields').style.display = type === 'crypto' ? 'block' : 'none';
            document.getElementById('etfFields').style.display = type === 'etf-us' ? 'block' : 'none';
            document.getElementById('fundFields').style.display = type === 'fund-tr' ? 'block' : 'none';
            document.getElementById('viopFields').style.display = type === 'viop' ? 'block' : 'none';

            // Update price unit label
            document.getElementById('priceUnit').textContent = type === 'stock-tr' ? '(TRY)' : '(USD)';

            // Clear stock selection when switching
            document.getElementById('symbol').value = '';
            document.getElementById('name').value = '';
            document.getElementById('selectedStock').value = '';
            symbolSearch.value = '';

            // Clear ETF selection
            document.getElementById('etfSymbol').value = '';
            document.getElementById('etfName').value = '';
            document.getElementById('selectedEtf').value = '';
            document.getElementById('etfSearch').value = '';

            // Set default date for deposit
            if (type === 'deposit') {
                document.getElementById('depositStartDate').value = new Date().toISOString().split('T')[0];
            }
        }

        function switchFilter(filter) {
            currentFilter = filter;
            filterTabs.querySelectorAll('.filter-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.filter === filter);
            });
            renderHoldings();
        }

        function openModal(holding = null) {
            editingId = holding ? holding.id : null;
            document.getElementById('modalTitle').textContent = holding ? 'Varlƒ±k D√ºzenle' : 'Varlƒ±k Ekle';
            document.getElementById('submitBtn').textContent = holding ? 'G√ºncelle' : 'Ekle';
            document.getElementById('deleteBtn').style.display = holding ? 'block' : 'none';

            addForm.reset();
            // Reset currency selections
            document.querySelectorAll('#currencySelect .currency-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('#currencySelect .currency-btn[data-currency="TRY"]').classList.add('active');
            document.querySelectorAll('#depositCurrencySelect .currency-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('#depositCurrencySelect .currency-btn[data-currency="TRY"]').classList.add('active');
            document.querySelectorAll('#viopPositionSelect .currency-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('#viopPositionSelect .currency-btn[data-position="long"]').classList.add('active');
            document.getElementById('symbol').value = '';
            document.getElementById('name').value = '';
            document.getElementById('selectedStock').value = '';
            document.getElementById('etfSymbol').value = '';
            document.getElementById('etfName').value = '';
            document.getElementById('selectedEtf').value = '';

            if (holding) {
                switchType(holding.type);
                fillForm(holding);
            } else {
                switchType('stock-us');
            }

            addModal.classList.add('active');
        }

        function fillForm(h) {
            if (h.type === 'stock-us' || h.type === 'stock-tr') {
                document.getElementById('symbol').value = h.symbol;
                document.getElementById('name').value = h.name || '';
                document.getElementById('selectedStock').value = h.name ? `${h.symbol} - ${h.name}` : h.symbol;
                document.getElementById('quantity').value = h.quantity;
                document.getElementById('buyPrice').value = h.buyPrice;
                document.getElementById('currentPrice').value = h.currentPrice;
            } else if (h.type === 'cash') {
                document.querySelectorAll('#currencySelect .currency-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`#currencySelect .currency-btn[data-currency="${h.currency}"]`)?.classList.add('active');
                document.getElementById('cashAmount').value = h.amount;
                document.getElementById('cashNote').value = h.note || '';
            } else if (h.type === 'deposit') {
                document.querySelectorAll('#depositCurrencySelect .currency-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`#depositCurrencySelect .currency-btn[data-currency="${h.currency}"]`)?.classList.add('active');
                document.getElementById('depositAmount').value = h.principal;
                document.getElementById('interestRate').value = h.interestRate;
                document.getElementById('depositStartDate').value = h.startDate;
                document.getElementById('depositNote').value = h.note || '';
            } else if (h.type === 'gold') {
                document.getElementById('goldType').value = h.goldType;
                document.getElementById('goldQuantity').value = h.quantity;
                document.getElementById('goldBuyPrice').value = h.buyPrice;
                document.getElementById('goldCurrentPrice').value = h.currentPrice;
            } else if (h.type === 'crypto') {
                document.getElementById('cryptoSymbol').value = h.symbol;
                document.getElementById('cryptoQuantity').value = h.quantity;
                document.getElementById('cryptoBuyPrice').value = h.buyPrice;
                document.getElementById('cryptoCurrentPrice').value = h.currentPrice;
            } else if (h.type === 'etf-us') {
                document.getElementById('etfSymbol').value = h.symbol;
                document.getElementById('etfName').value = h.name || '';
                document.getElementById('selectedEtf').value = h.name ? `${h.symbol} - ${h.name}` : h.symbol;
                document.getElementById('etfQuantity').value = h.quantity;
                document.getElementById('etfBuyPrice').value = h.buyPrice;
                document.getElementById('etfCurrentPrice').value = h.currentPrice;
            } else if (h.type === 'fund-tr') {
                document.getElementById('fundCode').value = h.symbol;
                document.getElementById('fundName').value = h.name || '';
                document.getElementById('fundQuantity').value = h.quantity;
                document.getElementById('fundBuyPrice').value = h.buyPrice;
                document.getElementById('fundCurrentPrice').value = h.currentPrice;
            } else if (h.type === 'viop') {
                document.getElementById('viopContract').value = h.contract;
                document.querySelectorAll('#viopPositionSelect .currency-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`#viopPositionSelect .currency-btn[data-position="${h.position}"]`)?.classList.add('active');
                document.getElementById('viopQuantity').value = h.quantity;
                document.getElementById('viopEntryPrice').value = h.entryPrice;
                document.getElementById('viopCurrentPrice').value = h.currentPrice;
                document.getElementById('viopMultiplier').value = h.multiplier || 100;
            }
        }

        function closeModal() {
            addModal.classList.remove('active');
            editingId = null;
        }

        function handleSubmit(e) {
            e.preventDefault();

            let holding = {
                id: editingId || Date.now().toString(),
                type: currentType,
                createdAt: editingId ? holdings.find(h => h.id === editingId)?.createdAt : new Date().toISOString()
            };

            if (currentType === 'stock-us' || currentType === 'stock-tr') {
                const symbol = document.getElementById('symbol').value.trim().toUpperCase();
                const quantity = parseFloat(document.getElementById('quantity').value);
                const buyPrice = parseFloat(document.getElementById('buyPrice').value);
                const currentPrice = parseFloat(document.getElementById('currentPrice').value);

                if (!symbol || isNaN(quantity) || isNaN(buyPrice) || isNaN(currentPrice)) {
                    showToast('L√ºtfen t√ºm alanlarƒ± doldurun', true);
                    return;
                }

                holding = {
                    ...holding,
                    symbol,
                    name: document.getElementById('name').value.trim(),
                    quantity,
                    buyPrice,
                    currentPrice
                };
            } else if (currentType === 'cash') {
                const currency = document.querySelector('#currencySelect .currency-btn.active')?.dataset.currency || 'TRY';
                const amount = parseFloat(document.getElementById('cashAmount').value);

                if (isNaN(amount)) {
                    showToast('L√ºtfen miktar girin', true);
                    return;
                }

                holding = {
                    ...holding,
                    currency,
                    amount,
                    note: document.getElementById('cashNote').value.trim()
                };
            } else if (currentType === 'deposit') {
                const currency = document.querySelector('#depositCurrencySelect .currency-btn.active')?.dataset.currency || 'TRY';
                const principal = parseFloat(document.getElementById('depositAmount').value);
                const interestRate = parseFloat(document.getElementById('interestRate').value);
                const startDate = document.getElementById('depositStartDate').value;

                if (isNaN(principal) || isNaN(interestRate) || !startDate) {
                    showToast('L√ºtfen t√ºm alanlarƒ± doldurun', true);
                    return;
                }

                holding = {
                    ...holding,
                    currency,
                    principal,
                    interestRate,
                    startDate,
                    note: document.getElementById('depositNote').value.trim()
                };
            } else if (currentType === 'gold') {
                const goldType = document.getElementById('goldType').value;
                const quantity = parseFloat(document.getElementById('goldQuantity').value);
                const buyPrice = parseFloat(document.getElementById('goldBuyPrice').value);
                const currentPrice = parseFloat(document.getElementById('goldCurrentPrice').value);

                if (isNaN(quantity) || isNaN(buyPrice) || isNaN(currentPrice)) {
                    showToast('L√ºtfen t√ºm alanlarƒ± doldurun', true);
                    return;
                }

                holding = { ...holding, goldType, quantity, buyPrice, currentPrice };
            } else if (currentType === 'crypto') {
                const symbol = document.getElementById('cryptoSymbol').value.trim().toUpperCase();
                const quantity = parseFloat(document.getElementById('cryptoQuantity').value);
                const buyPrice = parseFloat(document.getElementById('cryptoBuyPrice').value);
                const currentPrice = parseFloat(document.getElementById('cryptoCurrentPrice').value);

                if (!symbol || isNaN(quantity) || isNaN(buyPrice) || isNaN(currentPrice)) {
                    showToast('L√ºtfen t√ºm alanlarƒ± doldurun', true);
                    return;
                }

                holding = { ...holding, symbol, quantity, buyPrice, currentPrice };
            } else if (currentType === 'etf-us') {
                const symbol = document.getElementById('etfSymbol').value.trim().toUpperCase();
                const quantity = parseFloat(document.getElementById('etfQuantity').value);
                const buyPrice = parseFloat(document.getElementById('etfBuyPrice').value);
                const currentPrice = parseFloat(document.getElementById('etfCurrentPrice').value);

                if (!symbol || isNaN(quantity) || isNaN(buyPrice) || isNaN(currentPrice)) {
                    showToast('L√ºtfen t√ºm alanlarƒ± doldurun', true);
                    return;
                }

                holding = {
                    ...holding,
                    symbol,
                    name: document.getElementById('etfName').value.trim(),
                    quantity,
                    buyPrice,
                    currentPrice
                };
            } else if (currentType === 'fund-tr') {
                const symbol = document.getElementById('fundCode').value.trim().toUpperCase();
                const name = document.getElementById('fundName').value.trim();
                const quantity = parseFloat(document.getElementById('fundQuantity').value);
                const buyPrice = parseFloat(document.getElementById('fundBuyPrice').value);
                const currentPrice = parseFloat(document.getElementById('fundCurrentPrice').value);

                if (!symbol || isNaN(quantity) || isNaN(buyPrice) || isNaN(currentPrice)) {
                    showToast('L√ºtfen t√ºm alanlarƒ± doldurun', true);
                    return;
                }

                holding = { ...holding, symbol, name, quantity, buyPrice, currentPrice };
            } else if (currentType === 'viop') {
                const contract = document.getElementById('viopContract').value.trim().toUpperCase();
                const position = document.querySelector('#viopPositionSelect .currency-btn.active')?.dataset.position || 'long';
                const quantity = parseFloat(document.getElementById('viopQuantity').value);
                const entryPrice = parseFloat(document.getElementById('viopEntryPrice').value);
                const currentPrice = parseFloat(document.getElementById('viopCurrentPrice').value);
                const multiplier = parseFloat(document.getElementById('viopMultiplier').value) || 100;

                if (!contract || isNaN(quantity) || isNaN(entryPrice) || isNaN(currentPrice)) {
                    showToast('L√ºtfen t√ºm alanlarƒ± doldurun', true);
                    return;
                }

                holding = { ...holding, contract, position, quantity, entryPrice, currentPrice, multiplier };
            }

            if (editingId) {
                holdings = holdings.map(h => h.id === editingId ? holding : h);
            } else {
                holdings.push(holding);
            }

            saveData();
            render();
            closeModal();
        }

        function deleteHolding(id) {
            holdings = holdings.filter(h => h.id !== id);
            saveData();
            render();
        }

        // Calculate deposit current value with interest
        function getDepositCurrentValue(h) {
            const startDate = new Date(h.startDate);
            const now = new Date();
            const daysElapsed = Math.max(0, (now - startDate) / (1000 * 60 * 60 * 24));
            const interest = h.principal * (h.interestRate / 100) * (daysElapsed / 365);
            return h.principal + interest;
        }

        // Get holding value in USD
        function getHoldingValueUSD(h) {
            if (h.type === 'stock-us') {
                return h.quantity * h.currentPrice; // Already USD
            } else if (h.type === 'stock-tr') {
                return h.quantity * h.currentPrice / usdTryRate; // TRY to USD
            } else if (h.type === 'cash') {
                if (h.currency === 'USD') return h.amount;
                if (h.currency === 'TRY') return h.amount / usdTryRate;
                return h.amount * exchangeRates[h.currency];
            } else if (h.type === 'deposit') {
                const currentValue = getDepositCurrentValue(h);
                if (h.currency === 'USD') return currentValue;
                if (h.currency === 'TRY') return currentValue / usdTryRate;
                return currentValue * exchangeRates[h.currency];
            } else if (h.type === 'gold') {
                return h.quantity * h.currentPrice / usdTryRate; // TRY to USD
            } else if (h.type === 'crypto') {
                return h.quantity * h.currentPrice; // USD
            } else if (h.type === 'etf-us') {
                return h.quantity * h.currentPrice; // USD
            } else if (h.type === 'fund-tr') {
                return h.quantity * h.currentPrice / usdTryRate; // TRY to USD
            } else if (h.type === 'viop') {
                // Vƒ∞OP kar/zarar hesabƒ±: (g√ºncel - giri≈ü) * adet * √ßarpan
                const priceDiff = h.currentPrice - h.entryPrice;
                const direction = h.position === 'long' ? 1 : -1;
                const pnl = priceDiff * h.quantity * (h.multiplier || 100) * direction;
                // Ba≈ülangƒ±√ß teminatƒ± + kar/zarar (TRY cinsinden, USD'ye √ßevir)
                const initialMargin = h.entryPrice * h.quantity * (h.multiplier || 100) * 0.1; // ~%10 teminat varsayƒ±mƒ±
                return (initialMargin + pnl) / usdTryRate;
            }
            return 0;
        }

        // Get holding cost in USD
        function getHoldingCostUSD(h) {
            if (h.type === 'stock-us') {
                return h.quantity * h.buyPrice;
            } else if (h.type === 'stock-tr') {
                return h.quantity * h.buyPrice / usdTryRate;
            } else if (h.type === 'cash') {
                return getHoldingValueUSD(h); // No profit/loss for cash
            } else if (h.type === 'deposit') {
                // Cost is the principal
                if (h.currency === 'USD') return h.principal;
                if (h.currency === 'TRY') return h.principal / usdTryRate;
                return h.principal * exchangeRates[h.currency];
            } else if (h.type === 'gold') {
                return h.quantity * h.buyPrice / usdTryRate;
            } else if (h.type === 'crypto') {
                return h.quantity * h.buyPrice;
            } else if (h.type === 'etf-us') {
                return h.quantity * h.buyPrice;
            } else if (h.type === 'fund-tr') {
                return h.quantity * h.buyPrice / usdTryRate;
            } else if (h.type === 'viop') {
                // Giri≈ü teminatƒ±
                const initialMargin = h.entryPrice * h.quantity * (h.multiplier || 100) * 0.1;
                return initialMargin / usdTryRate;
            }
            return 0;
        }

        function formatUSD(amount) {
            return '$' + new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function render() {
            renderSummary();
            renderPerformance();
            renderChart();
            renderHoldings();
        }

        function renderSummary() {
            const total = holdings.reduce((sum, h) => sum + getHoldingValueUSD(h), 0);
            const cost = holdings.reduce((sum, h) => sum + getHoldingCostUSD(h), 0);
            const profitLoss = total - cost;
            const profitPercent = cost > 0 ? (profitLoss / cost * 100) : 0;

            const stocks = holdings.filter(h => h.type.startsWith('stock') || h.type === 'crypto' || h.type === 'gold');
            const stockTotal = stocks.reduce((sum, h) => sum + getHoldingValueUSD(h), 0);

            const cash = holdings.filter(h => h.type === 'cash');
            const cashTotal = cash.reduce((sum, h) => sum + getHoldingValueUSD(h), 0);

            document.getElementById('totalValue').textContent = formatUSD(total);
            document.getElementById('stockValue').textContent = formatUSD(stockTotal);
            document.getElementById('cashValue').textContent = formatUSD(cashTotal);

            const profitEl = document.getElementById('totalProfitLoss');
            if (cost > 0) {
                const sign = profitLoss >= 0 ? '+' : '';
                profitEl.textContent = `${sign}${formatUSD(profitLoss)} (${sign}${profitPercent.toFixed(1)}%)`;
                profitEl.className = `summary-sub ${profitLoss >= 0 ? 'profit' : 'loss'}`;
            } else {
                profitEl.textContent = '--';
                profitEl.className = 'summary-sub';
            }
        }

        function renderPerformance() {
            const weeklyEl = document.getElementById('weeklyPerf');
            const monthlyEl = document.getElementById('monthlyPerf');
            const yearlyEl = document.getElementById('yearlyPerf');

            const now = new Date();
            const oneWeekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            const oneMonthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
            const oneYearAgo = new Date(now - 365 * 24 * 60 * 60 * 1000);

            const currentValue = holdings.reduce((sum, h) => sum + getHoldingValueUSD(h), 0);

            // Find historical values
            const weeklyHistory = priceHistory.find(p => new Date(p.date) <= oneWeekAgo);
            const monthlyHistory = priceHistory.find(p => new Date(p.date) <= oneMonthAgo);
            const yearlyHistory = priceHistory.find(p => new Date(p.date) <= oneYearAgo);

            if (weeklyHistory && weeklyHistory.totalValue > 0) {
                const weeklyChange = ((currentValue - weeklyHistory.totalValue) / weeklyHistory.totalValue * 100);
                const sign = weeklyChange >= 0 ? '+' : '';
                weeklyEl.textContent = `${sign}${weeklyChange.toFixed(1)}%`;
                weeklyEl.className = `perf-value ${weeklyChange >= 0 ? 'profit' : 'loss'}`;
            } else {
                weeklyEl.textContent = '--';
                weeklyEl.className = 'perf-value';
            }

            if (monthlyHistory && monthlyHistory.totalValue > 0) {
                const monthlyChange = ((currentValue - monthlyHistory.totalValue) / monthlyHistory.totalValue * 100);
                const sign = monthlyChange >= 0 ? '+' : '';
                monthlyEl.textContent = `${sign}${monthlyChange.toFixed(1)}%`;
                monthlyEl.className = `perf-value ${monthlyChange >= 0 ? 'profit' : 'loss'}`;
            } else {
                monthlyEl.textContent = '--';
                monthlyEl.className = 'perf-value';
            }

            if (yearlyHistory && yearlyHistory.totalValue > 0) {
                const yearlyChange = ((currentValue - yearlyHistory.totalValue) / yearlyHistory.totalValue * 100);
                const sign = yearlyChange >= 0 ? '+' : '';
                yearlyEl.textContent = `${sign}${yearlyChange.toFixed(1)}%`;
                yearlyEl.className = `perf-value ${yearlyChange >= 0 ? 'profit' : 'loss'}`;
            } else {
                yearlyEl.textContent = '--';
                yearlyEl.className = 'perf-value';
            }
        }

        function renderChart() {
            const categories = [
                { type: 'stock-us', label: 'ABD Hisse', color: '#3b82f6' },
                { type: 'stock-tr', label: 'BIST Hisse', color: '#ef4444' },
                { type: 'etf-us', label: 'ETF', color: '#06b6d4' },
                { type: 'fund-tr', label: 'Fon', color: '#ec4899' },
                { type: 'viop', label: 'Vƒ∞OP', color: '#84cc16' },
                { type: 'cash', label: 'Kasa', color: '#10b981' },
                { type: 'deposit', label: 'Faiz', color: '#8b5cf6' },
                { type: 'gold', label: 'Altƒ±n', color: '#fbbf24' },
                { type: 'crypto', label: 'Kripto', color: '#f59e0b' }
            ];

            const total = holdings.reduce((sum, h) => sum + getHoldingValueUSD(h), 0);
            const data = categories.map(cat => ({
                ...cat,
                value: holdings.filter(h => h.type === cat.type).reduce((sum, h) => sum + getHoldingValueUSD(h), 0)
            })).filter(d => d.value > 0);

            const chartBar = document.getElementById('chartBar');
            const chartLegend = document.getElementById('chartLegend');

            if (total === 0) {
                chartBar.innerHTML = '<div style="width:100%;background:var(--border-color);height:100%;border-radius:6px;"></div>';
                chartLegend.innerHTML = '<span style="color:var(--text-muted);">Hen√ºz varlƒ±k yok</span>';
                return;
            }

            chartBar.innerHTML = data.map(d =>
                `<div class="chart-segment" style="width:${(d.value/total*100).toFixed(1)}%;background:${d.color};"></div>`
            ).join('');

            chartLegend.innerHTML = data.map(d => `
                <div class="legend-item">
                    <div class="legend-dot" style="background:${d.color}"></div>
                    <span>${d.label} ${(d.value/total*100).toFixed(0)}%</span>
                </div>
            `).join('');
        }

        function renderHoldings() {
            let filtered = holdings;
            if (currentFilter !== 'all') {
                filtered = holdings.filter(h => h.type === currentFilter);
            }

            filtered = filtered.sort((a, b) => getHoldingValueUSD(b) - getHoldingValueUSD(a));

            if (filtered.length === 0) {
                holdingsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-wallet"></i>
                        <p>Hen√ºz varlƒ±k eklenmedi</p>
                    </div>
                `;
                return;
            }

            holdingsList.innerHTML = filtered.map(h => renderHoldingCard(h)).join('');

            holdingsList.querySelectorAll('.holding-card').forEach((card, i) => {
                card.addEventListener('click', () => openModal(filtered[i]));
            });
        }

        function renderHoldingCard(h) {
            const valueUSD = getHoldingValueUSD(h);
            const costUSD = getHoldingCostUSD(h);
            const profitLoss = valueUSD - costUSD;
            const profitPercent = costUSD > 0 ? (profitLoss / costUSD * 100) : 0;

            let icon = 'stock-us';
            let title = '';
            let detail = '';
            let emoji = 'üìä';

            if (h.type === 'stock-us') {
                icon = 'stock-us';
                emoji = 'üá∫üá∏';
                title = h.symbol;
                detail = `${h.quantity} adet ¬∑ $${h.currentPrice.toFixed(2)}`;
            } else if (h.type === 'stock-tr') {
                icon = 'stock-tr';
                emoji = 'üáπüá∑';
                title = h.symbol;
                detail = `${h.quantity} adet ¬∑ ‚Ç∫${h.currentPrice.toFixed(2)}`;
            } else if (h.type === 'cash') {
                icon = 'cash';
                emoji = 'üíµ';
                const symbols = { TRY: '‚Ç∫', USD: '$', EUR: '‚Ç¨', GBP: '¬£' };
                title = `${symbols[h.currency]}${h.amount.toLocaleString('tr-TR')} ${h.currency}`;
                detail = h.note || 'Kasa';
            } else if (h.type === 'deposit') {
                icon = 'deposit';
                emoji = 'üè¶';
                const symbols = { TRY: '‚Ç∫', USD: '$' };
                const currentValue = getDepositCurrentValue(h);
                const interest = currentValue - h.principal;
                title = h.note || 'Faiz Hesabƒ±';
                detail = `${symbols[h.currency]}${h.principal.toLocaleString('tr-TR')} ¬∑ %${h.interestRate} ¬∑ +${symbols[h.currency]}${interest.toFixed(0)} faiz`;
            } else if (h.type === 'gold') {
                icon = 'gold';
                emoji = 'ü•á';
                const goldNames = { gram: 'Gram Altƒ±n', ceyrek: '√áeyrek', yarim: 'Yarƒ±m', tam: 'Tam' };
                title = goldNames[h.goldType];
                detail = `${h.quantity} adet ¬∑ ‚Ç∫${h.currentPrice.toFixed(0)}`;
            } else if (h.type === 'crypto') {
                icon = 'crypto';
                emoji = '‚Çø';
                title = h.symbol;
                detail = `${h.quantity} ¬∑ $${h.currentPrice.toFixed(2)}`;
            } else if (h.type === 'etf-us') {
                icon = 'etf-us';
                emoji = 'üìä';
                title = h.symbol;
                detail = `${h.quantity} adet ¬∑ $${h.currentPrice.toFixed(2)}`;
            } else if (h.type === 'fund-tr') {
                icon = 'fund-tr';
                emoji = 'üìà';
                title = h.symbol;
                detail = `${h.quantity} pay ¬∑ ‚Ç∫${h.currentPrice.toFixed(2)}`;
            } else if (h.type === 'viop') {
                icon = 'viop';
                emoji = h.position === 'long' ? 'üìà' : 'üìâ';
                title = h.contract;
                const priceDiff = h.currentPrice - h.entryPrice;
                const direction = h.position === 'long' ? 1 : -1;
                const pnl = priceDiff * h.quantity * (h.multiplier || 100) * direction;
                const posLabel = h.position === 'long' ? 'L' : 'S';
                detail = `${h.quantity} kontrat ¬∑ ${posLabel} ¬∑ ‚Ç∫${pnl >= 0 ? '+' : ''}${pnl.toFixed(0)} K/Z`;
            }

            const sign = profitLoss >= 0 ? '+' : '';
            const profitClass = profitLoss >= 0 ? 'profit' : 'loss';
            const showProfitLoss = h.type !== 'cash';

            return `
                <div class="holding-card">
                    <div class="holding-icon ${icon}">
                        ${emoji}
                    </div>
                    <div class="holding-info">
                        <div class="holding-name">${title}${h.name ? ` ¬∑ ${h.name}` : ''}</div>
                        <div class="holding-detail">${detail}</div>
                    </div>
                    <div class="holding-values">
                        <div class="holding-value">${formatUSD(valueUSD)}</div>
                        ${showProfitLoss ? `<div class="holding-change ${profitClass}">${sign}${profitPercent.toFixed(1)}%</div>` : ''}
                    </div>
                </div>
            `;
        }

        // Data persistence
        function saveData() {
            // Record price history for performance tracking
            const currentValue = holdings.reduce((sum, h) => sum + getHoldingValueUSD(h), 0);
            const today = new Date().toISOString().split('T')[0];

            // Update or add today's entry
            const existingIndex = priceHistory.findIndex(p => p.date.startsWith(today));
            if (existingIndex >= 0) {
                priceHistory[existingIndex].totalValue = currentValue;
            } else {
                priceHistory.unshift({ date: new Date().toISOString(), totalValue: currentValue });
            }

            // Keep only last 400 days (for yearly performance)
            priceHistory = priceHistory.slice(0, 400);
        }

        function loadData() {
            // Data loaded via import
        }

        function exportData() {
            const data = {
                version: 2,
                exportDate: new Date().toISOString(),
                holdings: holdings,
                priceHistory: priceHistory,
                usdTryRate: usdTryRate
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.holdings && Array.isArray(data.holdings)) {
                        holdings = data.holdings;
                        priceHistory = data.priceHistory || [];
                        if (data.usdTryRate) usdTryRate = data.usdTryRate;
                        render();
                        showToast('Veriler ba≈üarƒ±yla y√ºklendi!');
                    } else {
                        showToast('Ge√ßersiz dosya formatƒ±', true);
                    }
                } catch (err) {
                    showToast('Dosya okunamadƒ±', true);
                }
            };
            reader.readAsText(file);
        }

        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: ${isError ? 'var(--accent-red)' : 'var(--accent-green)'};
                color: white;
                padding: 12px 24px;
                border-radius: 12px;
                font-weight: 500;
                z-index: 2000;
                animation: fadeInUp 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showBanner(message, isError = false) {
            const container = document.getElementById('bannerContainer');
            container.innerHTML = `
                <div class="update-banner ${isError ? 'error' : ''}">
                    <i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
                    <span>${message}</span>
                    <button class="close-banner" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function updateLastUpdateDisplay() {
            const el = document.getElementById('lastUpdate');
            if (lastUpdateTime) {
                const now = new Date();
                const diff = Math.floor((now - lastUpdateTime) / 60000);
                if (diff < 1) {
                    el.textContent = 'Son g√ºncelleme: Az √∂nce';
                } else if (diff < 60) {
                    el.textContent = `Son g√ºncelleme: ${diff} dakika √∂nce`;
                } else {
                    el.textContent = `Son g√ºncelleme: ${lastUpdateTime.toLocaleTimeString('tr-TR')}`;
                }
            }
        }

        // Import/Export buttons
        document.getElementById('exportBtn').addEventListener('click', () => {
            if (holdings.length === 0) {
                showToast('Dƒ±≈üa aktarƒ±lacak veri yok', true);
                return;
            }
            exportData();
        });

        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                importData(file);
                e.target.value = '';
            }
        });

        // Price Update via Poe API
        if (window.Poe) {
            window.Poe.registerHandler('price-update-handler', (result) => {
                const msg = result.responses[0];

                if (msg.status === 'error') {
                    refreshBtn.classList.remove('updating');
                    isUpdating = false;
                    showBanner('Fiyatlar g√ºncellenemedi', true);
                    return;
                }

                if (msg.status === 'complete') {
                    refreshBtn.classList.remove('updating');
                    refreshBtn.classList.add('success');
                    setTimeout(() => refreshBtn.classList.remove('success'), 2000);
                    isUpdating = false;

                    try {
                        const content = msg.content;
                        const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) ||
                                         content.match(/\{[\s\S]*"prices"[\s\S]*\}/);

                        let data;
                        if (jsonMatch) {
                            const jsonStr = jsonMatch[1] || jsonMatch[0];
                            data = JSON.parse(jsonStr);
                        } else {
                            data = JSON.parse(content);
                        }

                        if (data.prices) {
                            let updatedCount = 0;

                            holdings.forEach(h => {
                                if (h.type === 'stock-us' || h.type === 'stock-tr' || h.type === 'crypto' || h.type === 'etf-us' || h.type === 'fund-tr') {
                                    const key = h.symbol.toUpperCase();
                                    if (data.prices[key] !== undefined) {
                                        h.currentPrice = parseFloat(data.prices[key]);
                                        updatedCount++;
                                    }
                                }
                                if (h.type === 'viop') {
                                    const key = h.contract.toUpperCase();
                                    if (data.prices[key] !== undefined) {
                                        h.currentPrice = parseFloat(data.prices[key]);
                                        updatedCount++;
                                    }
                                }
                                if (h.type === 'gold') {
                                    if (data.prices['GOLD_GRAM'] !== undefined) {
                                        const gramPrice = parseFloat(data.prices['GOLD_GRAM']);
                                        const multipliers = { gram: 1, ceyrek: 1.75, yarim: 3.5, tam: 7 };
                                        h.currentPrice = gramPrice * (multipliers[h.goldType] || 1);
                                        updatedCount++;
                                    }
                                }
                            });

                            if (data.usdTryRate) {
                                usdTryRate = parseFloat(data.usdTryRate);
                            }

                            lastUpdateTime = new Date();
                            updateLastUpdateDisplay();
                            saveData();
                            render();
                            showBanner(`${updatedCount} varlƒ±k g√ºncellendi!`);
                        }
                    } catch (err) {
                        showBanner('Fiyat verisi i≈ülenemedi', true);
                    }
                }
            });
        }

        refreshBtn.addEventListener('click', async () => {
            if (isUpdating) return;

            const usStocks = holdings.filter(h => h.type === 'stock-us').map(h => h.symbol);
            const trStocks = holdings.filter(h => h.type === 'stock-tr').map(h => h.symbol);
            const cryptos = holdings.filter(h => h.type === 'crypto').map(h => h.symbol);
            const etfs = holdings.filter(h => h.type === 'etf-us').map(h => h.symbol);
            const funds = holdings.filter(h => h.type === 'fund-tr').map(h => h.symbol);
            const viops = holdings.filter(h => h.type === 'viop').map(h => h.contract);
            const hasGold = holdings.some(h => h.type === 'gold');

            if (usStocks.length === 0 && trStocks.length === 0 && cryptos.length === 0 &&
                etfs.length === 0 && funds.length === 0 && viops.length === 0 && !hasGold) {
                showToast('G√ºncellenecek varlƒ±k yok', true);
                return;
            }

            if (!window.Poe) {
                showBanner('Poe API kullanƒ±lamƒ±yor', true);
                return;
            }

            isUpdating = true;
            refreshBtn.classList.add('updating');

            let prompt = `A≈üaƒüƒ±daki varlƒ±klarƒ±n G√úNCEL fiyatlarƒ±nƒ± bul. SADECE JSON d√∂nd√ºr:`;

            if (usStocks.length > 0) {
                prompt += `\nABD Hisseleri (USD): ${[...new Set(usStocks)].join(', ')}`;
            }
            if (trStocks.length > 0) {
                prompt += `\nBIST Hisseleri (TRY): ${[...new Set(trStocks)].join(', ')}`;
            }
            if (etfs.length > 0) {
                prompt += `\nUS ETF'ler (USD): ${[...new Set(etfs)].join(', ')}`;
            }
            if (funds.length > 0) {
                prompt += `\nTR Fonlar (TRY, birim fiyat): ${[...new Set(funds)].join(', ')}`;
            }
            if (viops.length > 0) {
                prompt += `\nVƒ∞OP Kontratlarƒ± (TRY): ${[...new Set(viops)].join(', ')}`;
            }
            if (cryptos.length > 0) {
                prompt += `\nKripto (USD): ${[...new Set(cryptos)].join(', ')}`;
            }
            if (hasGold) {
                prompt += `\nGram Altƒ±n (TRY): GOLD_GRAM`;
            }
            prompt += `\nUSD/TRY kuru`;

            prompt += `\n\nFormat:
\`\`\`json
{"prices":{"AAPL":150.25,"THYAO":320,"SPY":580,"TI2":15.5,"F_XU030":9500,"BTC":95000,"GOLD_GRAM":3200},"usdTryRate":38.5}
\`\`\``;

            try {
                await window.Poe.sendUserMessage(
                    `@GPT-5.1 ${prompt} --web_search true`,
                    {
                        handler: 'price-update-handler',
                        stream: false,
                        openChat: false
                    }
                );
            } catch (err) {
                refreshBtn.classList.remove('updating');
                isUpdating = false;
                showBanner('G√ºncelleme ba≈ülatƒ±lamadƒ±', true);
            }
        });

        setInterval(updateLastUpdateDisplay, 60000);

        // Start
        init();
    </script>
</body>
</html>
