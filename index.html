<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PortfÃ¶y Takip</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a0f1c">

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Outfit,sans-serif;background:#0a0f1c;color:#fff}
.container{max-width:600px;margin:auto;padding:16px}
.card{background:#111827;border-radius:16px;padding:16px;margin-bottom:16px}
h1{margin:0 0 16px}
button{background:#3b82f6;border:none;color:#fff;padding:14px;border-radius:12px;width:100%;font-size:16px}
input,select{width:100%;padding:14px;border-radius:12px;border:none;margin-bottom:12px;font-size:16px}
footer{text-align:center;padding:32px;color:#94a3b8}
#lock{position:fixed;inset:0;background:#0a0f1c;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999}
.small{font-size:13px;color:#94a3b8}
</style>
</head>

<body>

<div id="lock">
<h2>ðŸ”’ PortfÃ¶y Kilitli</h2>
<input id="pin" type="password" maxlength="4" placeholder="PIN">
<button onclick="unlock()">GiriÅŸ</button>
</div>

<div class="container">
<h1>ðŸ“Š PortfÃ¶y Takip</h1>

<div class="card">
<select id="portfolioSelect" onchange="switchPortfolio()"></select>
<input id="newPortfolioName" placeholder="Yeni portfÃ¶y adÄ±">
<button onclick="addPortfolio()">âž• PortfÃ¶y Ekle</button>
</div>

<div class="card">
<h3>Toplam DeÄŸer</h3>
<h2 id="totalValue">$0</h2>
<p class="small" id="lastUpdate">â€”</p>
<button onclick="updatePrices()">ðŸ”„ FiyatlarÄ± GÃ¼ncelle</button>
</div>

<div class="card">
<canvas id="chart"></canvas>
</div>

<div class="card">
<select id="type">
<option value="stock">Hisse (US)</option>
<option value="crypto">Kripto</option>
<option value="commodity">Emtia</option>
<option value="cash">Nakit</option>
</select>

<input id="symbol" placeholder="Sembol (AAPL, BTC, GOLD)">
<input id="quantity" type="number" placeholder="Miktar">
<input id="price" type="number" placeholder="Fiyat (manuel girilebilir)">

<select id="commodityType">
<option value="gold">AltÄ±n</option>
<option value="silver">GÃ¼mÃ¼ÅŸ</option>
<option value="platinum">Platin</option>
<option value="copper">BakÄ±r</option>
</select>

<button onclick="addHolding()">âž• Ekle</button>
</div>

<div id="list"></div>

<footer>Made by <b>Dasdemir</b> ðŸ’™</footer>
</div>

<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js')}

let app=JSON.parse(localStorage.getItem('app'))||{
pin:'1234',
active:'main',
portfolios:{main:{name:'Ana PortfÃ¶y',holdings:[]}}
}

let active=app.active
let portfolios=app.portfolios
let usdTry=38

function save(){
app.active=active
app.portfolios=portfolios
localStorage.setItem('app',JSON.stringify(app))
render()
}

function unlock(){
if(!app.pin||pin.value===app.pin){
document.getElementById('lock').remove()
}else alert('PIN yanlÄ±ÅŸ')
}

function render(){
portfolioSelect.innerHTML=''
Object.keys(portfolios).forEach(id=>{
let o=document.createElement('option')
o.value=id;o.textContent=portfolios[id].name
if(id===active)o.selected=true
portfolioSelect.appendChild(o)
})

let holdings=portfolios[active].holdings
let total=0
list.innerHTML=''

holdings.forEach((h,i)=>{
let v=h.qty*h.price
total+=v
list.innerHTML+=`
<div class="card">
<b>${h.symbol}</b> (${h.type})<br>
${h.qty} x ${h.price.toFixed(2)}<br>
$${v.toFixed(2)}
<button onclick="del(${i})">Sil</button>
</div>`
})

totalValue.textContent='$'+total.toFixed(2)
drawChart(holdings)
}

function addHolding(){
let h={
type:type.value,
symbol:symbol.value.toUpperCase(),
qty:+quantity.value,
price:+price.value,
commodity:commodityType.value
}
portfolios[active].holdings.push(h)
save()
}

function del(i){
portfolios[active].holdings.splice(i,1)
save()
}

function addPortfolio(){
let name=newPortfolioName.value.trim()
if(!name)return
let id=Date.now().toString()
portfolios[id]={name,holdings:[]}
active=id
save()
newPortfolioName.value=''
}

function switchPortfolio(){
active=portfolioSelect.value
save()
}

function drawChart(holdings){
let data={}
holdings.forEach(h=>{
data[h.type]=(data[h.type]||0)+(h.qty*h.price)
})
new Chart(chart,{
type:'doughnut',
data:{labels:Object.keys(data),
datasets:[{data:Object.values(data),
backgroundColor:['#3b82f6','#f59e0b','#10b981','#ef4444']}]},
options:{plugins:{legend:{labels:{color:'white'}}}}
})
}

/* ðŸ”¥ OTOMATÄ°K FÄ°YAT GÃœNCELLEME */
async function updatePrices(){
let holdings=portfolios[active].holdings

// USD/TRY
let fx=await fetch('https://api.exchangerate.host/latest?base=USD&symbols=TRY').then(r=>r.json())
usdTry=fx.rates.TRY

// KRÄ°PTO
let cryptos=[...new Set(holdings.filter(h=>h.type==='crypto').map(h=>h.symbol.toLowerCase()))]
if(cryptos.length){
let cg=await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${cryptos.join(',')}&vs_currencies=usd`).then(r=>r.json())
holdings.forEach(h=>{
if(h.type==='crypto'&&cg[h.symbol.toLowerCase()])
h.price=cg[h.symbol.toLowerCase()].usd
})
}

// EMTÄ°A
let metals=await fetch('https://api.metals.live/v1/spot').then(r=>r.json())
let metalMap={}
metals.forEach(m=>metalMap[m[0]]=m[1])

holdings.forEach(h=>{
if(h.type==='commodity'){
if(h.commodity==='gold')h.price=metalMap.gold
if(h.commodity==='silver')h.price=metalMap.silver
if(h.commodity==='platinum')h.price=metalMap.platinum
if(h.commodity==='copper')h.price=metalMap.copper
}
})

// HÄ°SSE (STOOQ)
for(let h of holdings){
if(h.type==='stock'){
try{
let res=await fetch(`https://stooq.com/q/l/?s=${h.symbol.toLowerCase()}&f=sd2t2ohlcv&h&e=json`)
let j=await res.json()
if(j.data&&j.data[0]?.close)h.price=parseFloat(j.data[0].close)
}catch{}
}
}

document.getElementById('lastUpdate').textContent=
'Son gÃ¼ncelleme: '+new Date().toLocaleTimeString('tr-TR')

save()
}

render()
</script>
</body>
</html>
